// SpecializationDataConfig.java
package com.malware98.brokenpath.data.config;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.malware98.brokenpath.BrokenPath;
import net.minecraftforge.fml.loading.FMLPaths;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Path;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List; // Still needed for Gson/Collection types, but not for tags list itself
import java.util.Map;
import java.util.Optional;

/**
 * // --- Specialization Data Configuration ---
 * // Manages all configurable values related to player specializations.
 * // This includes the flat stat bonuses they provide.
 * // Implements the Singleton pattern for consistent access.
 */
public class SpecializationDataConfig {

    // // --- Singleton Instance ---
    private static SpecializationDataConfig INSTANCE;

    // // --- Logger ---
    private static final Logger LOGGER = LogManager.getLogger(BrokenPath.MOD_ID + "_SpecializationDataConfig");

    // // --- Gson Instance ---
    private static final Gson GSON = new GsonBuilder().setPrettyPrinting().create();

    // // --- Configuration File Path ---
    private static final String CONFIG_FILE_NAME = "brokenpath_player_specializations.json";
    private static final Path CONFIG_PATH = FMLPaths.CONFIGDIR.get().resolve(CONFIG_FILE_NAME);

    // // --- Configuration Values ---
    public Map<String, SpecializationSettings> specializationSettings;

    /**
     * // --- Private Constructor for Singleton ---
     * // Initializes default values for specialization configurations.
     */
    private SpecializationDataConfig() {
        initializeDefaults();
    }

    /**
     * // --- Singleton Access Method ---
     * @return The singleton instance of SpecializationDataConfig.
     */
    public static SpecializationDataConfig getInstance() {
        if (INSTANCE == null) {
            INSTANCE = new SpecializationDataConfig();
        }
        return INSTANCE;
    }

    /**
     * // --- Default Initialization Logic ---
     * // Sets up all specialization-related configuration values with their default settings.
     */
    private void initializeDefaults() {
        specializationSettings = new HashMap<>();
        float bonusValue = 30.0f; // Fixed bonus value for all specializations

        // CHAMPION Specializations
        // Champion's affinity bonus is Health. Champion's class bonus is Protection.
        // Specializations cannot give affinity bonus to HEALTH.
        specializationSettings.put("LEGION_OF_THE_BASTION", new SpecializationSettings(
                "PROTECTION", bonusValue // Can repeat class bonus
        ));
        specializationSettings.put("LEGION_OF_THE_SUN", new SpecializationSettings(
                "MANA", bonusValue
        ));
        specializationSettings.put("LEGION_OF_THE_OATH", new SpecializationSettings(
                "VIGOR", bonusValue
        ));

        // SORCERER Specializations
        // Sorcerer's affinity bonus is Mana. Sorcerer's class bonus is Vigor.
        // Specializations cannot give affinity bonus to MANA.
        specializationSettings.put("ACADEMY_OF_THE_ECLIPSE", new SpecializationSettings(
                "HEALTH", bonusValue
        ));
        specializationSettings.put("ACADEMY_OF_OBLIVION", new SpecializationSettings(
                "PROTECTION", bonusValue
        ));
        specializationSettings.put("ACADEMY_OF_LIGHTNING", new SpecializationSettings(
                "VIGOR", bonusValue // Can repeat class bonus
        ));

        // BERSERKER Specializations
        // Berserker's affinity bonus is Vigor. Berserker's class bonus is Health.
        // Specializations cannot give affinity bonus to VIGOR.
        specializationSettings.put("BLAZING_SHADOW_CLAN", new SpecializationSettings(
                "MANA", bonusValue
        ));
        specializationSettings.put("BLOODY_FANG_CLAN", new SpecializationSettings(
                "HEALTH", bonusValue // Can repeat class bonus
        ));
        specializationSettings.put("BESTIAL_PATH_CLAN", new SpecializationSettings(
                "PROTECTION", bonusValue
        ));

        // SHAMAN Specializations
        // Shaman's affinity bonus is Vigor. Shaman's class bonus is Protection.
        // Specializations cannot give affinity bonus to VIGOR.
        specializationSettings.put("SHARPENED_BONE_TRIBE", new SpecializationSettings(
                "MANA", bonusValue
        ));
        specializationSettings.put("ETERNAL_GUARD_TRIBE", new SpecializationSettings(
                "HEALTH", bonusValue
        ));
        specializationSettings.put("WITHERED_VOICE_TRIBE", new SpecializationSettings(
                "PROTECTION", bonusValue // Can repeat class bonus
        ));

        // EXPLORER Specializations
        // Explorer's affinity bonus is Vigor. Explorer's class bonus is Protection.
        // Specializations cannot give affinity bonus to VIGOR.
        specializationSettings.put("POISON_FANG_PATH", new SpecializationSettings(
                "MANA", bonusValue
        ));
        specializationSettings.put("HUNTERS_PATH", new SpecializationSettings(
                "HEALTH", bonusValue
        ));
        specializationSettings.put("BREEZE_PATH", new SpecializationSettings(
                "PROTECTION", bonusValue // Can repeat class bonus
        ));

        // CHANNELER Specializations
        // Channeler's affinity bonus is Mana. Channeler's class bonus is Health.
        // Specializations cannot give affinity bonus to MANA.
        specializationSettings.put("SERENE_TIDE_CIRCLE", new SpecializationSettings(
                "VIGOR", bonusValue
        ));
        specializationSettings.put("STORMY_LIGHTNING_CIRCLE", new SpecializationSettings(
                "PROTECTION", bonusValue
        ));
        specializationSettings.put("SLEEPING_SWAMP_CIRCLE", new SpecializationSettings(
                "HEALTH", bonusValue // Can repeat class bonus
        ));

        // VESTAL Specializations
        // Vestal's affinity bonus is Health. Vestal's class bonus is Mana.
        // Specializations cannot give affinity bonus to HEALTH.
        specializationSettings.put("WHITE_FLAME_BEACON", new SpecializationSettings(
                "PROTECTION", bonusValue
        ));
        specializationSettings.put("GOLDEN_MANTLE_BEACON", new SpecializationSettings(
                "VIGOR", bonusValue
        ));
        specializationSettings.put("CELESTIAL_JUDGMENT_BEACON", new SpecializationSettings(
                "MANA", bonusValue // Can repeat class bonus
        ));

        // TECHNOMANCER Specializations
        // Technomancer's affinity bonus is Protection. Technomancer's class bonus is Vigor.
        // Specializations cannot give affinity bonus to PROTECTION.
        specializationSettings.put("ZERO_APPROACH_PROTOCOL", new SpecializationSettings(
                "HEALTH", bonusValue
        ));
        specializationSettings.put("BINARY_INTERFERENCE_PROTOCOL", new SpecializationSettings(
                "MANA", bonusValue
        ));
        specializationSettings.put("ALPHA_ASSISTANCE_PROTOCOL", new SpecializationSettings(
                "VIGOR", bonusValue // Can repeat class bonus
        ));

        // NO_SPECIALIZATION entry (important fallback)
        specializationSettings.put("NO_SPECIALIZATION", new SpecializationSettings(
                "", 0.0f // No bonus stat name or value
        ));
    }

    /**
     * // --- Load Configuration from JSON ---
     * // Loads specialization configurations from 'brokenpath_player_specializations.json'.
     */
    public void loadConfig() {
        File configFile = CONFIG_PATH.toFile();

        if (configFile.exists()) {
            try (FileReader reader = new FileReader(configFile)) {
                SpecializationDataConfig loadedConfig = GSON.fromJson(reader, SpecializationDataConfig.class);
                if (loadedConfig != null && loadedConfig.specializationSettings != null) {
                    this.specializationSettings = loadedConfig.specializationSettings;
                    // No need for tags validation as tags have been removed.
                } else {
                    LOGGER.warn("Configuration file '{}' was empty or invalid JSON. Loading default specialization configurations.", CONFIG_FILE_NAME);
                    initializeDefaults();
                }
            } catch (Exception e) { // Catching generic Exception for robustness against JsonSyntaxException or IOException
                LOGGER.error("Error parsing or reading specialization configuration file '{}'. Loading default configurations. Error: {}", CONFIG_FILE_NAME, e.getMessage());
                initializeDefaults();
            }
        } else {
            LOGGER.info("Specialization configuration file '{}' not found. Creating with default configurations.", CONFIG_FILE_NAME);
            saveConfig(); // Create new file with defaults
        }
    }

    /**
     * // --- Save Configuration to JSON ---
     * // Saves the current specialization configuration to 'brokenpath_player_specializations.json'.
     */
    public void saveConfig() {
        File configFile = CONFIG_PATH.toFile();
        try (FileWriter writer = new FileWriter(configFile)) {
            GSON.toJson(this, writer);
        } catch (IOException e) {
            LOGGER.error("Failed to save specialization configuration file '{}'. Error: {}", CONFIG_FILE_NAME, e.getMessage());
        }
    }

    // // --- Getters for Configuration Values ---

    /**
     * // Retrieves the settings for a specific specialization.
     * @param specializationName The name of the specialization (e.g., "SWORD_MASTER").
     * @return The SpecializationSettings object for the specified specialization, or default empty settings if not found.
     */
    public SpecializationSettings getSpecializationSettings(String specializationName) {
        // Returns a new SpecializationSettings if specialization not found, to prevent NullPointerExceptions.
        // This default SpecializationSettings should have no bonus.
        return specializationSettings.getOrDefault(specializationName.toUpperCase(), new SpecializationSettings());
    }

    // // --- Nested Class for Specialization Settings ---
    /**
     * // Represents the configurable settings for a single player specialization.
     */
    public static class SpecializationSettings {
        public String statBonusName; // The name of the stat that receives the flat bonus (e.g., "HEALTH", "MANA")
        public float statBonusValue; // The value of the fixed flat bonus for this stat

        // Constructor for Gson deserialization (needs to be public and no-arg for default values if present in JSON)
        public SpecializationSettings() {
            this.statBonusName = "";
            this.statBonusValue = 0.0f;
        }

        public SpecializationSettings(String statBonusName, float statBonusValue) {
            this.statBonusName = statBonusName;
            this.statBonusValue = statBonusValue;
        }

        // Getters for easy access to specialization specific settings
        public String getStatBonusName() { return statBonusName; }
        public float getStatBonusValue() { return statBonusValue; }
    }
}
