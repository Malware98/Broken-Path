// AffinityTierDataConfig.java
package com.malware98.brokenpath.data.config;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.malware98.brokenpath.BrokenPath;
import net.minecraftforge.fml.loading.FMLPaths;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;

import java.io.File;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.nio.file.Path;

/**
 * // --- Affinity Tier Data Configuration ---
 * // Manages the configurable flat bonus values for each affinity tier (Ideal, Efficient, Acceptable, Deficient).
 * // These bonuses are delivered in two parts: upon class selection and upon specialization selection.
 * // Implements the Singleton pattern for consistent access.
 */
public class AffinityTierDataConfig {

    // // --- Singleton Instance ---
    private static AffinityTierDataConfig INSTANCE;

    // // --- Logger ---
    private static final Logger LOGGER = LogManager.getLogger(BrokenPath.MOD_ID + "_AffinityTierDataConfig");

    // // --- Gson Instance ---
    private static final Gson GSON = new GsonBuilder().setPrettyPrinting().create();

    // // --- Configuration File Path ---
    private static final String CONFIG_FILE_NAME = "brokenpath_affinity_tiers.json";
    private static final Path CONFIG_PATH = FMLPaths.CONFIGDIR.get().resolve(CONFIG_FILE_NAME);

    // // --- Configuration Values ---
    public float idealTierBonusClass;
    public float idealTierBonusSpecialization;

    public float efficientTierBonusClass;
    public float efficientTierBonusSpecialization;

    public float acceptableTierBonusClass;
    public float acceptableTierBonusSpecialization;

    public float deficientTierBonusClass;
    public float deficientTierBonusSpecialization;


    /**
     * // --- Private Constructor for Singleton ---
     * // Initializes default values for affinity tier configurations.
     */
    private AffinityTierDataConfig() {
        initializeDefaults();
    }

    /**
     * // --- Singleton Access Method ---
     * @return The singleton instance of AffinityTierDataConfig.
     */
    public static AffinityTierDataConfig getInstance() {
        if (INSTANCE == null) {
            INSTANCE = new AffinityTierDataConfig();
        }
        return INSTANCE;
    }

    /**
     * // --- Default Initialization Logic ---
     * // Sets up all affinity tier bonus values with their default settings.
     * // These values are based on the final agreed-upon table and split for phased delivery.
     */
    private void initializeDefaults() {
        // Tier "Ideal" (4 matching tags)
        // Total +90 points, split +45 for class, +45 for specialization
        idealTierBonusClass = 45.0f;
        idealTierBonusSpecialization = 45.0f;

        // Tier "Efficient" (3 matching tags)
        // Total +60 points, split +30 for class, +30 for specialization
        efficientTierBonusClass = 30.0f;
        efficientTierBonusSpecialization = 30.0f;

        // Tier "Acceptable" (2 matching tags)
        // Total +30 points, split +15 for class, +15 for specialization
        acceptableTierBonusClass = 15.0f;
        acceptableTierBonusSpecialization = 15.0f;

        // Tier "Deficient" (0-1 matching tags)
        // Total +0 points, split +0 for class, +0 for specialization
        deficientTierBonusClass = 0.0f;
        deficientTierBonusSpecialization = 0.0f;
    }

    /**
     * // --- Load Configuration from JSON ---
     * // Loads affinity tier configurations from 'brokenpath_affinity_tiers.json'.
     */
    public void loadConfig() {
        File configFile = CONFIG_PATH.toFile();

        if (configFile.exists()) {
            try (FileReader reader = new FileReader(configFile)) {
                AffinityTierDataConfig loadedConfig = GSON.fromJson(reader, AffinityTierDataConfig.class);
                if (loadedConfig != null) {
                    // Update current instance's fields with loaded values
                    this.idealTierBonusClass = loadedConfig.idealTierBonusClass;
                    this.idealTierBonusSpecialization = loadedConfig.idealTierBonusSpecialization;

                    this.efficientTierBonusClass = loadedConfig.efficientTierBonusClass;
                    this.efficientTierBonusSpecialization = loadedConfig.efficientTierBonusSpecialization;

                    this.acceptableTierBonusClass = loadedConfig.acceptableTierBonusClass;
                    this.acceptableTierBonusSpecialization = loadedConfig.acceptableTierBonusSpecialization;

                    this.deficientTierBonusClass = loadedConfig.deficientTierBonusClass;
                    this.deficientTierBonusSpecialization = loadedConfig.deficientTierBonusSpecialization;
                } else {
                    LOGGER.warn("Configuration file '{}' was empty or invalid JSON. Loading default affinity tier configurations.", CONFIG_FILE_NAME);
                    initializeDefaults(); // Re-initialize defaults if JSON is empty/invalid
                }
            } catch (Exception e) { // Catching generic Exception for robustness against JsonSyntaxException or IOException
                LOGGER.error("Error parsing or reading affinity tier configuration file '{}'. Loading default configurations. Error: {}", CONFIG_FILE_NAME, e.getMessage());
                initializeDefaults(); // Re-initialize defaults on error
            }
        } else {
            LOGGER.info("Affinity tier configuration file '{}' not found. Creating with default configurations.", CONFIG_FILE_NAME);
            saveConfig(); // Create new file with defaults
        }

        // Post-load safety net for critical values
        // Ensuring values are not negative or excessively small due to corruption.
        if (this.idealTierBonusClass < 0) this.idealTierBonusClass = 45.0f;
        if (this.efficientTierBonusClass < 0) this.efficientTierBonusClass = 30.0f;
        if (this.acceptableTierBonusClass < 0) this.acceptableTierBonusClass = 15.0f;
    }

    /**
     * // --- Save Configuration to JSON ---
     * // Saves the current affinity tier configuration to 'brokenpath_affinity_tiers.json'.
     */
    public void saveConfig() {
        File configFile = CONFIG_PATH.toFile();
        try (FileWriter writer = new FileWriter(configFile)) {
            GSON.toJson(this, writer);
        } catch (IOException e) {
            LOGGER.error("Failed to save affinity tier configuration file '{}'. Error: {}", CONFIG_FILE_NAME, e.getMessage());
        }
    }

    // // --- Getters for Configuration Values ---

    /**
     * // Retrieves the class selection bonus value for a given affinity tier.
     * @param matchingTags The number of matching tags between race and class.
     * @return The flat bonus value applied on class selection for the corresponding tier.
     */
    public float getClassSelectionTierBonus(int matchingTags) {
        if (matchingTags == 8) return idealTierBonusClass; // Ideal tier for 8 tags
        if (matchingTags >= 6) return efficientTierBonusClass; // Efficient tier (6-7 tags)
        if (matchingTags >= 3) return acceptableTierBonusClass; // Acceptable tier (3-5 tags)
        return deficientTierBonusClass; // 0-2 matching tags
    }

    /**
     * // Retrieves the specialization selection bonus value for a given affinity tier.
     * @param matchingTags The number of matching tags between race and class.
     * @return The flat bonus value applied on specialization selection for the corresponding tier.
     */
    public float getSpecializationSelectionTierBonus(int matchingTags) {
        if (matchingTags == 8) return idealTierBonusSpecialization; // Ideal tier for 8 tags
        if (matchingTags >= 6) return efficientTierBonusSpecialization; // Efficient tier (6-7 tags)
        if (matchingTags >= 3) return acceptableTierBonusSpecialization; // Acceptable tier (3-5 tags)
        return deficientTierBonusSpecialization; // 0-2 matching tags
    }

    // Direct getters for specific tier bonus values
    public float getIdealTierBonusClass() { return idealTierBonusClass; }
    public float getIdealTierBonusSpecialization() { return idealTierBonusSpecialization; }
    public float getEfficientTierBonusClass() { return efficientTierBonusClass; }
    public float getEfficientTierBonusSpecialization() { return efficientTierBonusSpecialization; }
    public float getAcceptableTierBonusClass() { return acceptableTierBonusClass; }
    public float getAcceptableTierBonusSpecialization() { return acceptableTierBonusSpecialization; }
    public float getDeficientTierBonusClass() { return deficientTierBonusClass; }
    public float getDeficientTierBonusSpecialization() { return deficientTierBonusSpecialization; }
}