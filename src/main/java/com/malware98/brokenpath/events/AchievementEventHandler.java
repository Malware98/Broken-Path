package com.malware98.brokenpath.events;

import com.malware98.brokenpath.BrokenPath;
import com.malware98.brokenpath.capabilities.IPlayerStats;
import com.malware98.brokenpath.capabilities.registries.ModCapabilities;
import com.malware98.brokenpath.data.ModBlockTags;
import com.malware98.brokenpath.data.ModConfigs;
import com.malware98.brokenpath.util.CapabilityUtils;
import net.minecraft.advancements.Advancement;
import net.minecraft.advancements.AdvancementProgress;
import net.minecraft.resources.ResourceKey;
import net.minecraft.resources.ResourceLocation;
import net.minecraft.server.ServerAdvancementManager;
import net.minecraft.server.level.ServerPlayer;
import net.minecraft.stats.Stat;
import net.minecraft.stats.Stats;
import net.minecraft.world.entity.LivingEntity;
import net.minecraft.world.entity.monster.Monster;
import net.minecraft.world.entity.player.Player;
import net.minecraft.world.food.FoodData;
import net.minecraft.world.item.ItemStack;
import net.minecraft.world.level.Level;
import net.minecraft.world.level.biome.Biome;
import net.minecraft.world.level.block.Blocks;
import net.minecraft.world.level.block.state.BlockState;
import net.minecraftforge.event.TickEvent;
import net.minecraftforge.event.entity.living.AnimalTameEvent;
import net.minecraftforge.event.entity.living.LivingDeathEvent;
import net.minecraftforge.event.entity.player.PlayerEvent;
import net.minecraftforge.event.level.BlockEvent;
import net.minecraftforge.eventbus.api.SubscribeEvent;
import net.minecraftforge.fml.common.Mod;
import net.minecraftforge.registries.ForgeRegistries;


/**
 * Event handler for custom achievements and player progression.
 * This class tracks various player actions (e.g., movement, mining, combat)
 * and updates their progress towards defined milestones, granting XP and
 * corresponding vanilla advancements upon completion.
 */
@Mod.EventBusSubscriber(modid = BrokenPath.MOD_ID, bus = Mod.EventBusSubscriber.Bus.FORGE)
public class AchievementEventHandler {

    // --- Player Tick Events ---
    /**
     * Processes player tick events for time-based, movement, and biome exploration achievements.
     * This runs on the server side to ensure accurate and persistent data tracking.
     *
     * @param event The player tick event.
     */
    @SubscribeEvent
    public static void onPlayerTick(TickEvent.PlayerTickEvent event) {
        // Only process on the logical server side and at the end of the tick for updated data.
        if (event.phase == TickEvent.Phase.END && !event.player.level().isClientSide()) {
            Player player = event.player;

            // Retrieve player stats capability, which holds achievement progress.
            CapabilityUtils.ifPlayerStatsPresent(player, playerStats -> {
                ModConfigs configs = ModConfigs.getInstance();
                FoodData foodStats = player.getFoodData();
                int foodLevel = foodStats.getFoodLevel();

                // --- Survival Root Achievement ---
                // Awarded when player's food level drops below 16 (indicating hunger).
                if (!playerStats.isAchievementCompleted("SURVIVAL_ROOT") && foodLevel <= 16) {
                    playerStats.setAchievementProgress("SURVIVAL_ROOT", 1); // Set progress to 1 for threshold check.
                    checkAndGrantAchievement(player, playerStats, "SURVIVAL_ROOT", configs.getAchievementConfig("SURVIVAL_ROOT"));
                }
                // --- Hunger Resistant Achievement ---
                // Awarded when the player reaches the "Starving" hunger stage (stage 3).
                if (playerStats.getHungerStage() == 3 && !playerStats.isAchievementCompleted("HUNGER_RESISTANT")) {
                    playerStats.setAchievementProgress("HUNGER_RESISTANT", 1); // Set progress to 1 as threshold is 1.
                    checkAndGrantAchievement(player, playerStats, "HUNGER_RESISTANT", configs.getAchievementConfig("HUNGER_RESISTANT"));
                }

                // --- Walking Achievements ---
                // Track actual walk distance from vanilla stats and convert to blocks for achievement progress.
                if (player instanceof ServerPlayer serverPlayer) {
                    Stat<ResourceLocation> walkStat = Stats.CUSTOM.get(Stats.WALK_ONE_CM);
                    int realWalkedCm = serverPlayer.getStats().getValue(walkStat);
                    int currentWalkProgress = realWalkedCm / 100; // 100 cm = 1 block.

                    // Update progress for all walking achievements.
                    playerStats.setAchievementProgress("FIRST_STEPS", currentWalkProgress);
                    playerStats.setAchievementProgress("CONSTANT_WALKER", currentWalkProgress);
                    playerStats.setAchievementProgress("TIRELESS_TRAVELER", currentWalkProgress);

                    // Check and grant specific walking achievements.
                    checkAndGrantAchievement(serverPlayer, playerStats, "FIRST_STEPS", configs.getAchievementConfig("FIRST_STEPS"));
                    checkAndGrantAchievement(serverPlayer, playerStats, "CONSTANT_WALKER", configs.getAchievementConfig("CONSTANT_WALKER"));
                    checkAndGrantAchievement(serverPlayer, playerStats, "TIRELESS_TRAVELER", configs.getAchievementConfig("TIRELESS_TRAVELER"));
                }

                // --- Survival Day Achievements ---
                // Track in-game days survived using `getDayTime()` (24000 ticks per Minecraft day).
                long currentDays = player.level().getDayTime() / 24000L;

                // Update progress for all survival day achievements.
                playerStats.setAchievementProgress("A_WHOLE_DAY", (int) currentDays);
                playerStats.setAchievementProgress("ONE_WEEK_WORLD", (int) currentDays);
                playerStats.setAchievementProgress("IM_STILL_ALIVE", (int) currentDays);

                // Check and grant specific survival day achievements.
                checkAndGrantAchievement(player, playerStats, "A_WHOLE_DAY", configs.getAchievementConfig("A_WHOLE_DAY"));
                checkAndGrantAchievement(player, playerStats, "ONE_WEEK_WORLD", configs.getAchievementConfig("ONE_WEEK_WORLD"));
                checkAndGrantAchievement(player, playerStats, "IM_STILL_ALIVE", configs.getAchievementConfig("IM_STILL_ALIVE"));

                // --- Biome Discovery Achievements ---
                ResourceKey<Biome> currentBiome = player.level().getBiome(player.blockPosition()).unwrapKey().orElse(null);
                if (currentBiome != null) {
                    // Use the player capability to add the discovered biome.
                    // The `addDiscoveredBiome()` method handles uniqueness and synchronization.
                    playerStats.addDiscoveredBiome(currentBiome);

                    // Get the updated count of unique discovered biomes from the capability.
                    int biomesCount = playerStats.getDiscoveredBiomes().size();

                    // --- Exploration Root Achievement ---
                    // Activated when the player discovers at least 2 unique biomes (leaves starting biome).
                    if (!playerStats.isAchievementCompleted("EXPLORATION_ROOT") && biomesCount >= 2) {
                        playerStats.setAchievementProgress("EXPLORATION_ROOT", 1);
                        checkAndGrantAchievement(player, playerStats, "EXPLORATION_ROOT", configs.getAchievementConfig("EXPLORATION_ROOT"));
                    }

                    // Update progress for all exploration achievements.
                    playerStats.setAchievementProgress("EXPLORER_NOVICE", biomesCount);
                    playerStats.setAchievementProgress("LOCAL_ADVENTURER", biomesCount);
                    playerStats.setAchievementProgress("ACCOMPLISHED_CARTOGRAPHER", biomesCount);

                    // Check and grant specific biome achievements.
                    checkAndGrantAchievement(player, playerStats, "EXPLORER_NOVICE", configs.getAchievementConfig("EXPLORER_NOVICE"));
                    checkAndGrantAchievement(player, playerStats, "LOCAL_ADVENTURER", configs.getAchievementConfig("LOCAL_ADVENTURER"));
                    checkAndGrantAchievement(player, playerStats, "ACCOMPLISHED_CARTOGRAPHER", configs.getAchievementConfig("ACCOMPLISHED_CARTOGRAPHER"));
                }
            });
        }
    }

    // --- Player Dimension Change Events ---
    /**
     * Handles achievements related to changing dimensions.
     * Tracks visited dimensions, which is crucial for the "Unknown Pioneer" achievement
     * that triggers upon death in a new primary dimension (Nether/End).
     *
     * @param event The player changed dimension event.
     */
    @SubscribeEvent
    public static void onPlayerChangedDimension(PlayerEvent.PlayerChangedDimensionEvent event) {
        // Only process on the server side to ensure data consistency.
        if (!event.getEntity().level().isClientSide()) {
            Player player = event.getEntity();
            ResourceKey<net.minecraft.world.level.Level> newDimension = event.getTo(); // Get the key of the new dimension.

            // Add the newly visited dimension to the player's stats capability.
            // `addVisitedDimension()` handles uniqueness and synchronization automatically.
            CapabilityUtils.ifPlayerStatsPresent(player, playerStats -> {
                playerStats.addVisitedDimension(newDimension);
            });
        }
    }

    // --- Block Breaking Events ---
    /**
     * Handles block breaking events for mining and harvesting achievements.
     * Differentiates between various block types (ores, stone, crops) using custom tags.
     *
     * @param event The block break event.
     */
    @SubscribeEvent
    public static void onBlockBroken(BlockEvent.BreakEvent event) {
        // Only process on the server side to prevent client-side desync.
        if (!event.getPlayer().level().isClientSide()) {
            Player player = event.getPlayer();
            BlockState brokenState = event.getState();

            CapabilityUtils.ifPlayerStatsPresent(player, playerStats -> {
                ModConfigs configs = ModConfigs.getInstance();

                // --- Mining Achievements (Ores) ---
                // Uses `ModBlockTags.ORES` to check if the broken block is any type of ore.
                if (brokenState.is(ModBlockTags.ORES)) {
                    int currentMinedOres = playerStats.getAchievementProgress("AMATEUR_EXCAVATOR") + 1; // Increment count.

                    // Update progress for all tiered mining achievements.
                    playerStats.setAchievementProgress("AMATEUR_EXCAVATOR", currentMinedOres);
                    playerStats.setAchievementProgress("SKILLED_MINERALOGIST", currentMinedOres);
                    playerStats.setAchievementProgress("GEOLOGIST_EXPERT", currentMinedOres);
                    playerStats.setAchievementProgress("MINING_MASTER", currentMinedOres);

                    // Check and grant specific mining achievements.
                    checkAndGrantAchievement(player, playerStats, "AMATEUR_EXCAVATOR", configs.getAchievementConfig("AMATEUR_EXCAVATOR"));
                    checkAndGrantAchievement(player, playerStats, "SKILLED_MINERALOGIST", configs.getAchievementConfig("SKILLED_MINERALOGIST"));
                    checkAndGrantAchievement(player, playerStats, "GEOLOGIST_EXPERT", configs.getAchievementConfig("GEOLOGIST_EXPERT"));
                    checkAndGrantAchievement(player, playerStats, "MINING_MASTER", configs.getAchievementConfig("MINING_MASTER"));
                }

                // --- Rock Finder Achievement ---
                // Tracks mining of general stone blocks using `ModBlockTags.STONE_BLOCKS`.
                if (!playerStats.isAchievementCompleted("ROCK_FINDER") && brokenState.is(ModBlockTags.STONE_BLOCKS)) {
                    int currentRocksMined = playerStats.getAchievementProgress("ROCK_FINDER") + 1;
                    playerStats.setAchievementProgress("ROCK_FINDER", currentRocksMined);
                    checkAndGrantAchievement(player, playerStats, "ROCK_FINDER", configs.getAchievementConfig("ROCK_FINDER"));
                }

                // --- Specific Mining Achievements ---
                // "Hidden Treasure" for mining Diamond Ore.
                if (!playerStats.isAchievementCompleted("HIDDEN_TREASURE") && brokenState.getBlock().equals(Blocks.DIAMOND_ORE)) {
                    int currentDiamondsMined = playerStats.getAchievementProgress("HIDDEN_TREASURE") + 1;
                    playerStats.setAchievementProgress("HIDDEN_TREASURE", currentDiamondsMined);
                    checkAndGrantAchievement(player, playerStats, "HIDDEN_TREASURE", configs.getAchievementConfig("HIDDEN_TREASURE"));
                }
                // "Master Obsidian" for mining Obsidian blocks.
                if (!playerStats.isAchievementCompleted("MASTER_OBSIDIAN") && brokenState.getBlock().equals(Blocks.OBSIDIAN)) {
                    int currentObsidianMined = playerStats.getAchievementProgress("MASTER_OBSIDIAN") + 1;
                    playerStats.setAchievementProgress("MASTER_OBSIDIAN", currentObsidianMined);
                    checkAndGrantAchievement(player, playerStats, "MASTER_OBSIDIAN", configs.getAchievementConfig("MASTER_OBSIDIAN"));
                }

                // --- Harvesting Achievements (Crops) ---
                // Uses `ModBlockTags.CROPS` to categorize various farmable blocks.
                if (brokenState.is(ModBlockTags.CROPS)) {
                    int currentHarvestedCrops = playerStats.getAchievementProgress("NOVICE_SOWER") + 1; // Increment count.

                    // Update progress for all tiered harvesting achievements.
                    playerStats.setAchievementProgress("NOVICE_SOWER", currentHarvestedCrops);
                    playerStats.setAchievementProgress("DEDICATED_FARMER", currentHarvestedCrops);
                    playerStats.setAchievementProgress("ACCOMPLISHED_AGRONOMIST", currentHarvestedCrops);
                    playerStats.setAchievementProgress("HARVEST_POWER", currentHarvestedCrops);

                    // Check and grant specific harvesting achievements.
                    checkAndGrantAchievement(player, playerStats, "NOVICE_SOWER", configs.getAchievementConfig("NOVICE_SOWER"));
                    checkAndGrantAchievement(player, playerStats, "DEDICATED_FARMER", configs.getAchievementConfig("DEDICATED_FARMER"));
                    checkAndGrantAchievement(player, playerStats, "ACCOMPLISHED_AGRONOMIST", configs.getAchievementConfig("ACCOMPLISHED_AGRONOMIST"));
                    checkAndGrantAchievement(player, playerStats, "HARVEST_POWER", configs.getAchievementConfig("HARVEST_POWER"));
                }
            });
        }
    }

    // --- Living Entity Death Events ---
    /**
     * Handles entity death events for combat achievements and the "Unknown Pioneer" achievement.
     *
     * @param event The living death event.
     */
    @SubscribeEvent
    public static void onLivingDeath(LivingDeathEvent event) {
        // --- Combat Achievements (Killing Hostile Mobs) ---
        // Only process if the damage source is a player and on the server side.
        if (event.getSource().getEntity() instanceof Player player && !player.level().isClientSide()) {
            LivingEntity deadEntity = event.getEntity();
            // Only count hostile mobs (instances of `Monster`).
            if (deadEntity.isDeadOrDying() && !deadEntity.isInvulnerable() && deadEntity instanceof Monster) {
                CapabilityUtils.ifPlayerStatsPresent(player, playerStats -> {
                    ModConfigs configs = ModConfigs.getInstance();
                    int currentKills = playerStats.getAchievementProgress("FLEDGLING_ADVOCATE") + 1; // Increment kill count.

                    // Update progress for all tiered combat achievements.
                    playerStats.setAchievementProgress("FLEDGLING_ADVOCATE", currentKills);
                    playerStats.setAchievementProgress("CREATURE_HUNTER", currentKills);
                    playerStats.setAchievementProgress("THREATS_EXTERMINATOR", currentKills);
                    playerStats.setAchievementProgress("SHADOWS_TERROR", currentKills);
                    playerStats.setAchievementProgress("MASACRE_MASTER", currentKills);

                    // Check and grant specific combat achievements.
                    checkAndGrantAchievement(player, playerStats, "FLEDGLING_ADVOCATE", configs.getAchievementConfig("FLEDGLING_ADVOCATE"));
                    checkAndGrantAchievement(player, playerStats, "CREATURE_HUNTER", configs.getAchievementConfig("CREATURE_HUNTER"));
                    checkAndGrantAchievement(player, playerStats, "THREATS_EXTERMINATOR", configs.getAchievementConfig("THREATS_EXTERMINATOR"));
                    checkAndGrantAchievement(player, playerStats, "SHADOWS_TERROR", configs.getAchievementConfig("SHADOWS_TERROR"));
                    checkAndGrantAchievement(player, playerStats, "MASACRE_MASTER", configs.getAchievementConfig("MASACRE_MASTER"));
                });
            }
        }

        // --- "Unknown Pioneer" Achievement (Dying in a New Dimension) ---
        // This achievement is triggered upon a player dying in a new primary dimension (Nether/End) for the first time.
        if (event.getEntity() instanceof Player playerEntity) { // Cast to Player to access player-specific methods.
            CapabilityUtils.ifPlayerStatsPresent(playerEntity, playerStats -> {
                ModConfigs configs = ModConfigs.getInstance();
                String pioneerAchievementKey = "UNKNOWN_PIONEER";

                // Only check if the achievement has not already been completed.
                if (!playerStats.isAchievementCompleted(pioneerAchievementKey)) {
                    ResourceKey<net.minecraft.world.level.Level> currentDimension = playerEntity.level().dimension();

                    // Check if the current dimension is Nether or End, AND if the player had previously visited it.
                    // The `addVisitedDimension` method in `onPlayerChangedDimension` tracks visited dimensions.
                    boolean isNewDimensionAndDiedThere = (currentDimension == Level.NETHER || currentDimension == Level.END) &&
                            playerStats.getVisitedDimensions().contains(currentDimension);

                    // If conditions are met, set progress and grant the achievement.
                    if (isNewDimensionAndDiedThere) {
                        playerStats.setAchievementProgress(pioneerAchievementKey, 1); // Threshold is 1 for this achievement.
                        checkAndGrantAchievement(playerEntity, playerStats, pioneerAchievementKey, configs.getAchievementConfig(pioneerAchievementKey));
                    }
                }
            });
        }
    }

    // --- Item Crafted Events ---
    /**
     * Handles item crafting events for crafting achievements.
     * Tracks the number of unique items crafted by the player.
     *
     * @param event The item crafted event.
     */
    @SubscribeEvent
    public static void onItemCrafted(PlayerEvent.ItemCraftedEvent event) {
        // Only process on the server side to ensure data accuracy.
        if (!event.getEntity().level().isClientSide()) {
            Player player = event.getEntity();
            ResourceLocation craftedItemId = ForgeRegistries.ITEMS.getKey(event.getCrafting().getItem());

            if (craftedItemId != null) {
                CapabilityUtils.ifPlayerStatsPresent(player, playerStats -> {
                    // Add the unique crafted item ID to player stats.
                    // `addCraftedUniqueItem()` handles uniqueness and synchronization automatically.
                    playerStats.addCraftedUniqueItem(craftedItemId);

                    // Update achievement progress based on the current count of unique crafted items.
                    int uniqueItemsCraftedCount = playerStats.getCraftedUniqueItems().size();

                    ModConfigs configs = ModConfigs.getInstance();

                    // --- Crafting Achievements ---
                    // "Novice Crafter": Root achievement for crafting, based on 1 unique item.
                    playerStats.setAchievementProgress("NOVICE_CRAFTER", uniqueItemsCraftedCount);
                    // Update progress for all tiered crafting achievements.
                    playerStats.setAchievementProgress("CREATIVE_CRAFTER", uniqueItemsCraftedCount);
                    playerStats.setAchievementProgress("ARTISAN_APPRENTICE", uniqueItemsCraftedCount);
                    playerStats.setAchievementProgress("MASTER_CRAFTSMAN", uniqueItemsCraftedCount);

                    // Check and grant specific crafting achievements.
                    checkAndGrantAchievement(player, playerStats, "NOVICE_CRAFTER", configs.getAchievementConfig("NOVICE_CRAFTER"));
                    checkAndGrantAchievement(player, playerStats, "CREATIVE_CRAFTER", configs.getAchievementConfig("CREATIVE_CRAFTER"));
                    checkAndGrantAchievement(player, playerStats, "ARTISAN_APPRENTICE", configs.getAchievementConfig("ARTISAN_APPRENTICE"));
                    checkAndGrantAchievement(player, playerStats, "MASTER_CRAFTSMAN", configs.getAchievementConfig("MASTER_CRAFTSMAN"));
                });
            }
        }
    }

    // --- Item Smelted Events ---
    /**
     * Handles item smelting events for smelting-related achievements.
     * Tracks both edible items smelted and the total count of all items smelted.
     *
     * @param event The item smelted event.
     */
    @SubscribeEvent
    public static void onItemSmelted(PlayerEvent.ItemSmeltedEvent event) {
        Player player = event.getEntity();
        // Only process on the server side to avoid client-side discrepancies.
        if (player == null || player.level().isClientSide()) {
            return;
        }

        ItemStack itemStack = event.getSmelting();
        if (itemStack.isEmpty()) {
            return;
        }

        ResourceLocation itemId = ForgeRegistries.ITEMS.getKey(itemStack.getItem());
        if (itemId == null) {
            return;
        }

        String itemIdString = itemId.toString();
        ModConfigs configs = ModConfigs.getInstance();

        CapabilityUtils.ifPlayerStatsPresent(player, playerStats -> {
            // --- Smelting Achievements ---
            // "Art of Kitchen": Tracks smelting of specific edible items.
            // A more flexible approach could involve a custom ItemTag for edible smeltables.
            if (itemIdString.equals("minecraft:cooked_beef") || itemIdString.equals("minecraft:cooked_porkchop") ||
                    itemIdString.equals("minecraft:cooked_chicken") || itemIdString.equals("minecraft:cooked_mutton") ||
                    itemIdString.equals("minecraft:cooked_rabbit") || itemIdString.equals("minecraft:cooked_fish") ||
                    itemIdString.equals("minecraft:cooked_salmon") || itemIdString.equals("minecraft:baked_potato") ||
                    itemIdString.equals("minecraft:dried_kelp")) {

                int currentCookedItems = playerStats.getAchievementProgress("ART_KITCHEN") + itemStack.getCount();
                playerStats.setAchievementProgress("ART_KITCHEN", currentCookedItems);
                checkAndGrantAchievement(player, playerStats, "ART_KITCHEN", configs.getAchievementConfig("ART_KITCHEN"));
            }

            // "Tireless Furnace": Tracks the total number of items smelted, regardless of type.
            int currentTotalSmeltedItems = playerStats.getAchievementProgress("TIRELESS_FURNACE") + itemStack.getCount();
            playerStats.setAchievementProgress("TIRELESS_FURNACE", currentTotalSmeltedItems);
            checkAndGrantAchievement(player, playerStats, "TIRELESS_FURNACE", configs.getAchievementConfig("TIRELESS_FURNACE"));
        });
    }

    // --- Animal Taming Events ---
    /**
     * Handles animal taming events for related achievements.
     * Tracks both the total number of tamed animals and the count of unique species tamed.
     *
     * @param event The animal tame event.
     */
    @SubscribeEvent
    public static void onAnimalTamed(AnimalTameEvent event) {
        Player player = event.getTamer();
        // Only process on the server side.
        if (player == null || player.level().isClientSide()) {
            return;
        }

        ResourceLocation entityId = ForgeRegistries.ENTITY_TYPES.getKey(event.getAnimal().getType());
        if (entityId == null) {
            return;
        }

        ModConfigs configs = ModConfigs.getInstance();

        CapabilityUtils.ifPlayerStatsPresent(player, playerStats -> {
            // "Beast Tamer": Tracks any animal taming, incrementing per tame.
            int currentTamedAnimals = playerStats.getAchievementProgress("BEAST_TAMER") + 1;
            playerStats.setAchievementProgress("BEAST_TAMER", currentTamedAnimals);
            checkAndGrantAchievement(player, playerStats, "BEAST_TAMER", configs.getAchievementConfig("BEAST_TAMER"));

            // "Tireless Shepherd": Tracks taming of *unique* animal species.
            // The `addTamedAnimal()` method in PlayerStats ensures only unique entity IDs are counted.
            playerStats.addTamedAnimal(entityId);
            int uniqueTamedAnimals = playerStats.getTamedAnimals().size();
            playerStats.setAchievementProgress("TIRELESS_SHEPHERD", uniqueTamedAnimals);
            checkAndGrantAchievement(player, playerStats, "TIRELESS_SHEPHERD", configs.getAchievementConfig("TIRELESS_SHEPHERD"));
        });
    }

    // --- Helper Methods ---
    /**
     * Centralized helper function to check if an achievement's progress meets its threshold,
     * then marks it as completed, grants the corresponding vanilla advancement, and awards XP.
     *
     * @param player         The player to check and reward.
     * @param playerStats    The player's stats capability containing achievement progress.
     * @param achievementKey The string key identifier for the achievement (e.g., "FIRST_STEPS").
     * @param config         The {@link ModConfigs.AchievementConfig} object defining this achievement's rewards and threshold.
     */
    private static void checkAndGrantAchievement(Player player, IPlayerStats playerStats, String achievementKey, ModConfigs.AchievementConfig config) {
        // Skip if the achievement configuration is missing or if the achievement is already completed.
        if (config == null || playerStats.isAchievementCompleted(achievementKey)) {
            return;
        }

        // Check if the player's current progress for this achievement meets or exceeds the required threshold.
        if (playerStats.getAchievementProgress(achievementKey) >= config.threshold) {
            playerStats.setAchievementCompleted(achievementKey, true); // Mark the achievement as completed in player stats.

            // Grant the corresponding vanilla Minecraft advancement to show a toast/notification.
            grantAdvancement(player, achievementKey);

            // Award XP to the player using the mod's custom XP system.
            player.getCapability(ModCapabilities.PLAYER_XP_CAPABILITY).ifPresent(playerXP -> {
                playerXP.addExperience(config.xpReward);
            });
        }
    }

    /**
     * Grants a vanilla Minecraft advancement to a player.
     * This method links the mod's custom achievement system to the game's built-in advancement system,
     * allowing for in-game notifications and UI integration.
     *
     * @param player         The player to grant the advancement to.
     * @param achievementKey The key of the achievement, used to construct the corresponding advancement ID.
     */
    private static void grantAdvancement(Player player, String achievementKey) {
        // Only grant advancements on the logical server side.
        if (player instanceof ServerPlayer serverPlayer) {
            // Construct the ResourceLocation for the advancement, typically "modid:achievement_key_lowercase".
            ResourceLocation advancementId = new ResourceLocation(BrokenPath.MOD_ID, achievementKey.toLowerCase());

            // Ensure the server instance is available to access the advancement manager.
            if (serverPlayer.getServer() == null) {
                BrokenPath.LOGGER.warn("Server is null for player {}. Cannot grant advancement '{}'.", serverPlayer.getName().getString(), achievementKey);
                return;
            }

            ServerAdvancementManager advancementManager = serverPlayer.getServer().getAdvancements();
            Advancement advancement = advancementManager.getAdvancement(advancementId);

            if (advancement != null) {
                AdvancementProgress progress = serverPlayer.getAdvancements().getOrStartProgress(advancement);
                // Check if the advancement is not already done.
                if (!progress.isDone()) {
                    // Award the advancement. For custom advancements using "minecraft:impossible" trigger,
                    // awarding any criterion (often a dummy "always_true" one) completes it.
                    advancement.getCriteria().keySet().stream().findFirst().ifPresent(criteria -> {
                        serverPlayer.getAdvancements().award(advancement, criteria);
                        BrokenPath.LOGGER.info("Advancement '{}' granted to player {}", achievementKey, serverPlayer.getName().getString());
                    });
                }
            } else {
                // Log a warning if the corresponding advancement JSON file is missing or incorrectly named.
                BrokenPath.LOGGER.warn("Advancement '{}' not found for player {}. Make sure the JSON file exists and is correctly named in data/{}/advancements/.", achievementKey, serverPlayer.getName().getString(), BrokenPath.MOD_ID);
            }
        }
    }
}